---
title: "Survival analysis"
output: html_document
---

```{r setup, include=FALSE}
library(survival)
# library(ggpubr)
library(flextable)
library(gtsummary)
source(here::here('code','initiation.R'))
source(here('code','data_preparation.R'))
knitr::opts_chunk$set(echo = FALSE)
```

## Clinical summary table

Compared to the adjuvant chemotherapy group, patients in the surveillence group tends to be older and present with better prognostic profile. 

```{r,echo=FALSE,warning=FALSE}
tbl_summary(data=clinical_multi_df[,!c('patient_id')],
            by='patient_group',
            label = list(age_at_diagnosis ~ 'Age at diagnosis',
                         os_time ~ 'Follow up time',
                         os_status ~ 'Number of overall death',
                         pfs_time ~ 'Progression free survival time',
                         pfs_status ~ 'Number of disease progression',
                         patient_group ~ 'patient group',
                         figo_staging ~ 'figo staging',
                         performance_status ~ 'performance status',
                         brca_status ~ 'brca status',
                         surgical_outcome ~ 'surgical outcome',
                         maintenance_therapy ~ 'maintenance therapy'),
            missing='no',
            theme_gtsummary_journal(journal='jama')) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p() %>% # test for a difference between groups
  # modify_header(label = "**Variable**",
  #               stat_1 = '**3 cycle surgery**',
  #               stat_2 = '**6 cycle chemo change surgery**',
  #               stat_3 = '**6 cycle no chemo change surgery**',
  #               stat_4 = "**6 cycle no surgery**") %>% # update the column header
  bold_labels()



```


## KM Survival curve w.r.t overall survival

Plot KM curve with respect to adjuvant management option: adjuvant chemo vs surveillence
```{r KM curve os,echo=FALSE,warning=FALSE}

survminer::ggsurvplot(
  fit = survfit(Surv(time=os_time,event=os_status) ~ patient_group, data = clinical_df),
  xlab = "Years", 
  ylab = "Overall survival probability",
  # risk.table = T,
  pval=T,
  pval.method=T,
  # cumevents = T,
  break.time.by = 1,
  # surv.median.line = "v",  # add the median survival pointer.
  legend.labs = c("3 cycle surgery",'6 cycle surgery'),
  legend= 'right', 
  pval.coord=c(0,0.04),
  pval.method.coord=c(0,0.12),
  palette = 'Dark2',
)

```

## KM Survival curve w.r.t progression free survival

Plot KM curve with respect to adjuvant management option: adjuvant chemo vs surveillence
```{r KM curve rfs,echo=FALSE,warning=FALSE}

survminer::ggsurvplot(
  fit = survfit(Surv(time=pfs_time,event=pfs_status) ~ patient_group, data = clinical_df), 
  xlab = "Years", 
  ylab = "Progression free survival probability",
  # risk.table = T,
  pval=T,
  pval.method=T,
  # cumevents = T,
  break.time.by = 1,
  # surv.median.line = "v",  # add the median survival pointer.
  legend='right',
  legend.labs = c("3 cycle surgery",'6 cycle surgery'),
  pval.coord=c(5,0.02),
  pval.method.coord=c(5,0.1),
  palette = 'Dark2'
)

```

## Missing data pattern
```{r missing data plot,echo=F}
# TODO can be replaced with naniar

clinical_multi_df %>% naniar::vis_miss()

clinical_multi_df %>% naniar::vis_miss()

na_pattern_df <- as.data.table(clinical_multi_df[,apply(.SD,2,function(x){return(is.na(x))}),.SDcols=!c('patient_id')])
na_pattern_df[,patient_id:=clinical_multi_df[,patient_id]]

na_pattern_plot_df <- melt(na_pattern_df,id.vars='patient_id')

ggplot(data=na_pattern_plot_df)+
  geom_tile(aes(x=patient_id,y=variable,fill=value),colour='black')+
  labs(fill='Missing status',x='patient id')+
  scale_y_discrete(labels=rid_of_underscore)+
  scale_fill_brewer(palette = 'RdYlGn',labels=c('FALSE'='present','TRUE'='missing'))+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

```


## Multivariate cox regression

Cox analysis for overall survival adjusting for the following clinical parameters: age at diagnosis, , baseline histological grade, cancer staging after surgery

```{r multi-cox os, echo=FALSE}
coxph_os_model <- coxph(
  Surv(time = os_time, event = os_status) ~ type_of_chemo_cleaned + change_in_chemo + patient_group + age_at_diagnosis +
    figo_staging + performance_status + brca_status +
    surgical_outcome + maintenance_therapy,
  data = clinical_multi_df
) 

coxph_os_model_less_surgical <- coxph(
  Surv(time = os_time, event = os_status) ~ type_of_chemo_cleaned + change_in_chemo + patient_group + age_at_diagnosis +
    figo_staging + performance_status + brca_status + maintenance_therapy,
  data = clinical_multi_df
) 

coxph_os_model_less_brac <- coxph(
  Surv(time = os_time, event = os_status) ~ type_of_chemo_cleaned + change_in_chemo + patient_group + age_at_diagnosis +
    figo_staging + performance_status + 
    maintenance_therapy + surgical_outcome,
  data = clinical_multi_df
) 


coxph_os_model %>%
  generics::tidy(exponentiate = TRUE, conf.int = TRUE)

```

## Multivariate cox regression with pfs

Cox analysis for recurrence free survival adjusting 

```{r multi-cox pfs, echo=FALSE}

coxph_ps_model <- coxph(
  Surv(time = pfs_time, event = pfs_status) ~ type_of_chemo_cleaned+ change_in_chemo + patient_group + age_at_diagnosis +
    figo_staging + performance_status + brca_status +
    surgical_outcome + maintenance_therapy,
  data = clinical_df
) 

coxph_ps_model_less_surgical <- coxph(
  Surv(time = pfs_time, event = pfs_status) ~ type_of_chemo_cleaned+ change_in_chemo + patient_group + age_at_diagnosis +
    figo_staging + performance_status + brca_status + maintenance_therapy,
  data = clinical_df
) 

coxph_ps_model_less_brca <- coxph(
  Surv(time = pfs_time, event = pfs_status) ~ type_of_chemo_cleaned+ change_in_chemo + patient_group + age_at_diagnosis +
    figo_staging + performance_status + brca_status +
    surgical_outcome + maintenance_therapy,
  data = clinical_df
) 

coxph_ps_model %>%
  generics::tidy(exponentiate = TRUE, conf.int = TRUE)


```

## Multi cox analysis table

```{r ,echo=FALSE}
os_surv_table <- coxph_os_model %>%
  tbl_regression(
    exponentiate = TRUE,
    label = list(
      age_at_diagnosis ~ 'age at diagnosis',
      patient_group ~ 'patient group',
      figo_staging ~ 'figo staging',
      performance_status ~ 'performance status',
      brca_status ~ 'brca status',
      surgical_outcome ~ 'surgical outcome',
      maintenance_therapy ~ 'maintenance therapy'
    )
  ) %>%
  add_n() %>%
  add_significance_stars(hide_p=FALSE,hide_ci=FALSE) %>%
  bold_p()


pfs_surv_table <- coxph_ps_model %>%
  tbl_regression(
    exponentiate = TRUE,
    label = list(
      age_at_diagnosis ~ 'age at diagnosis',
      patient_group ~ 'patient group',
      figo_staging ~ 'figo staging',
      performance_status ~ 'performance status',
      brca_status ~ 'brca status',
      surgical_outcome ~ 'surgical outcome',
      maintenance_therapy ~ 'maintenance therapy'
    )
  ) %>%
  add_n() %>%
  add_significance_stars(hide_p=FALSE,hide_ci=FALSE)%>%
  bold_p()
# 
# summary_table <- clinical_multi_df[,.(age_at_diagnosis,patient_group,figo_staging,performance_status,
#                          brca_status,surgical_outcome,maintenance_therapy)] %>% 
#   tbl_summary(missing = "no") %>% 
#   add_n() %>% 
#   modify_header(stat_0 ~ "**n (%)**") %>%
#   modify_footnote(stat_0 ~ NA_character_)


combined_survival_table <-
  tbl_merge(
    tbls = list(os_surv_table, pfs_surv_table),
    tab_spanner = c("**Overall survival**", "**Progression free survival**")
  )

combined_survival_table
```

## Multi cox analysis table less brca

```{r ,echo=FALSE}
os_surv_table <- coxph_os_model_less_brac %>%
  tbl_regression(
    exponentiate = TRUE,
    label = list(
      age_at_diagnosis ~ 'age at diagnosis',
      patient_group ~ 'patient group',
      figo_staging ~ 'figo staging',
      performance_status ~ 'performance status',
      surgical_outcome ~ 'surgical outcome',
      maintenance_therapy ~ 'maintenance therapy'
    )
  ) %>%
  add_n() %>%
  add_significance_stars()


pfs_surv_table <- coxph_ps_model_less_brca %>%
  tbl_regression(
    exponentiate = TRUE,
    label = list(
      age_at_diagnosis ~ 'age at diagnosis',
      patient_group ~ 'patient group',
      figo_staging ~ 'figo staging',
      performance_status ~ 'performance status',
      surgical_outcome ~ 'surgical outcome',
      maintenance_therapy ~ 'maintenance therapy'
    )
  ) %>%
  add_n() %>%
  add_significance_stars()
# 
# summary_table <- clinical_multi_df[,.(age_at_diagnosis,patient_group,figo_staging,performance_status,
#                          brca_status,surgical_outcome,maintenance_therapy)] %>% 
#   tbl_summary(missing = "no") %>% 
#   add_n() %>% 
#   modify_header(stat_0 ~ "**n (%)**") %>%
#   modify_footnote(stat_0 ~ NA_character_)


combined_survival_table <-
  tbl_merge(
    tbls = list(os_surv_table, pfs_surv_table),
    tab_spanner = c("**Overall survival**", "**Progression free survival**")
  )

combined_survival_table
```

## Multi cox analysis table less surgical

```{r ,echo=FALSE}
os_surv_table <- coxph_os_model_less_surgical %>%
  tbl_regression(
    exponentiate = TRUE,
    label = list(
      age_at_diagnosis ~ 'age at diagnosis',
      patient_group ~ 'patient group',
      figo_staging ~ 'figo staging',
      performance_status ~ 'performance status',
      brca_status ~ 'brca status',
      maintenance_therapy ~ 'maintenance therapy'
    )
  ) %>%
  add_n() %>%
  add_significance_stars()


pfs_surv_table <- coxph_ps_model_less_surgical %>%
  tbl_regression(
    exponentiate = TRUE,
    label = list(
      age_at_diagnosis ~ 'age at diagnosis',
      patient_group ~ 'patient group',
      figo_staging ~ 'figo staging',
      performance_status ~ 'performance status',
      brca_status ~ 'brca status',
      maintenance_therapy ~ 'maintenance therapy'
    )
  ) %>%
  add_n() %>%
  add_significance_stars()
# 
# summary_table <- clinical_multi_df[,.(age_at_diagnosis,patient_group,figo_staging,performance_status,
#                          brca_status,surgical_outcome,maintenance_therapy)] %>% 
#   tbl_summary(missing = "no") %>% 
#   add_n() %>% 
#   modify_header(stat_0 ~ "**n (%)**") %>%
#   modify_footnote(stat_0 ~ NA_character_)


combined_survival_table <-
  tbl_merge(
    tbls = list(os_surv_table, pfs_surv_table),
    tab_spanner = c("**Overall survival**", "**Progression free survival**")
  )

combined_survival_table
```

### Type of chemo's impact on operability
```{r barplot}
clinical_df %>%
  select(outcome_after_6_cycles, type_of_chemo_cleaned) %>% 
  drop_na() %>% 
  count(outcome_after_6_cycles, type_of_chemo_cleaned) %>% 
  ggplot() +
  geom_col() +
  aes(x = type_of_chemo_cleaned, fill = outcome_after_6_cycles, y = n) +
  xlab("Type of Chemotherapy")
  

```
### change in chemo vs no change in chemo

```{r chi-squre}
clinical_df %>% count(change_in_chemo, outcome_after_6_cycles) %>% 
  drop_na() %>% 
  pivot_wider(names_from = change_in_chemo, values_from = n) %>% 
  column_to_rownames("outcome_after_6_cycles") %>% 
  # mutate(no_change = replace_na(no_change, 0)) 
  chisq.test()
```

