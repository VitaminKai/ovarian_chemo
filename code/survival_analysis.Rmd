---
title: "Survival analysis"
output: html_document
---

```{r setup, include=FALSE}
library(survival)
# library(ggpubr)
library(flextable)
library(gtsummary)
source(here::here('code','initiation.R'))
source(here('code','data_preparation.R'))
knitr::opts_chunk$set(echo = FALSE)
```

## Clinical summary table

Compared to the adjuvant chemotherapy group, patients in the surveillence group tends to be older and present with better prognostic profile. 

```{r,echo=FALSE,warning=FALSE}
tbl_summary(data=clinical_multi_df[,!c('patient_id')],
            by='patient_group',
            label = list(age_at_diagnosis ~ 'Age at diagnosis',
                         os_time ~ 'Follow up time',
                         os_status ~ 'Number of overall death',
                         pfs_time ~ 'Progression free survival time',
                         pfs_status ~ 'Number of disease progression',
                         patient_group ~ 'patient group',
                         figo_staging ~ 'figo staging',
                         performance_status ~ 'performance status',
                         brca_status ~ 'brca status',
                         surgical_outcome ~ 'surgical outcome',
                         maintenance_therapy ~ 'maintenance therapy'),
            missing='no',
            theme_gtsummary_journal(journal='jama')) %>%
  add_n() %>% # add column with total number of non-missing observations
  add_p() %>% # test for a difference between groups
  # modify_header(label = "**Variable**",
  #               stat_1 = '**3 cycle surgery**',
  #               stat_2 = '**6 cycle chemo change surgery**',
  #               stat_3 = '**6 cycle no chemo change surgery**',
  #               stat_4 = "**6 cycle no surgery**") %>% # update the column header
  bold_labels()



```


## KM Survival curve w.r.t overall survival

Plot KM curve with respect to adjuvant management option: adjuvant chemo vs surveillence
```{r KM curve os,echo=FALSE,warning=FALSE}

survminer::ggsurvplot(
  fit = survfit(Surv(time=os_time,event=os_status) ~ patient_group, data = clinical_df),
  xlab = "Years", 
  ylab = "Overall survival probability",
  # risk.table = T,
  pval=T,
  pval.method=T,
  # cumevents = T,
  break.time.by = 1,
  # surv.median.line = "v",  # add the median survival pointer.
  legend.labs = c("3 cycle surgery",'6 cycle chemo change surgery',
                  '6 cycle no chemo change surgery',"6 cycle no surgery"),
  legend= 'right', 
  pval.coord=c(0,0.04),
  pval.method.coord=c(0,0.12),
  palette = 'Dark2',
)

```

## KM Survival curve w.r.t progression free survival

Plot KM curve with respect to adjuvant management option: adjuvant chemo vs surveillence
```{r KM curve rfs,echo=FALSE,warning=FALSE}

survminer::ggsurvplot(
  fit = survfit(Surv(time=pfs_time,event=pfs_status) ~ patient_group, data = clinical_df), 
  xlab = "Years", 
  ylab = "Progression free survival probability",
  # risk.table = T,
  pval=T,
  pval.method=T,
  # cumevents = T,
  break.time.by = 1,
  # surv.median.line = "v",  # add the median survival pointer.
  legend='right',
  legend.labs = c("3 cycle surgery",'6 cycle chemo change surgery',
                  '6 cycle no chemo change surgery',"6 cycle no surgery"),
  pval.coord=c(5,0.02),
  pval.method.coord=c(5,0.1),
  palette = 'Dark2'
)

```

## Missing data pattern
```{r missing data plot,echo=F}

na_pattern_df <- as.data.table(clinical_multi_df[,apply(.SD,2,function(x){return(is.na(x))}),.SDcols=!c('patient_id')])
na_pattern_df[,patient_id:=clinical_multi_df[,patient_id]]

na_pattern_plot_df <- melt(na_pattern_df,id.vars='patient_id')

ggplot(data=na_pattern_plot_df)+
  geom_tile(aes(x=patient_id,y=variable,fill=value),colour='black')+
  labs(fill='Missing status',x='patient id')+
  scale_y_discrete(labels=rid_of_underscore)+
  scale_fill_brewer(palette = 'RdYlGn',labels=c('FALSE'='present','TRUE'='missing'))+
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank())

```


## Multivariate cox regression

Cox analysis for overall survival adjusting for the following clinical parameters: age at diagnosis, , baseline histological grade, cancer staging after surgery

```{r multi-cox os, echo=FALSE}

coxph(Surv(time=os_time,event=os_status) ~ patient_group+age_at_diagnosis+figo_staging+performance_status+brca_status+
        surgical_outcome+maintenance_therapy, data = clinical_multi_df)%>%
  generics::tidy(exponentiate=TRUE,conf.int=TRUE)

```

## Multivariate cox regression with pfs

Cox analysis for recurrence free survival adjusting 

```{r multi-cox pfs, echo=FALSE}

coxph(Surv(time=pfs_time,event=pfs_status) ~ patient_group+age_at_diagnosis+figo_staging+performance_status+brca_status+
        surgical_outcome+maintenance_therapy, data = clinical_df) %>%
    generics::tidy(exponentiate=TRUE,conf.int=TRUE)


```

## Multi cox analysis table

```{r cox table,echo=FALSE}

os_surv_table <-coxph(Surv(time=os_time,event=os_status) ~
                        patient_group+age_at_diagnosis+figo_staging+performance_status+
                        brca_status+surgical_outcome+maintenance_therapy,
                      data = clinical_multi_df) %>%
  tbl_regression(exponentiate = TRUE,
                 label = list(age_at_diagnosis ~ 'age at diagnosis',
                              patient_group ~ 'patient group',
                              figo_staging ~ 'figo staging',
                              performance_status ~ 'performance status',
                              brca_status ~ 'brca status',
                              surgical_outcome ~ 'surgical outcome',
                              maintenance_therapy ~ 'maintenance therapy')) %>%
  add_n() %>%
  add_significance_stars()

pfs_surv_table <-coxph(Surv(time=pfs_time,event=pfs_status) ~
                         patient_group+age_at_diagnosis+figo_staging+performance_status+
                         brca_status+surgical_outcome+maintenance_therapy, 
                       data = clinical_multi_df) %>%
  tbl_regression(exponentiate = TRUE,
                 label = list(age_at_diagnosis ~ 'age at diagnosis',
                              patient_group ~ 'patient group',
                              figo_staging ~ 'figo staging',
                              performance_status ~ 'performance status',
                              brca_status ~ 'brca status',
                              surgical_outcome ~ 'surgical outcome',
                              maintenance_therapy ~ 'maintenance therapy')) %>%
  add_n()%>%
  add_significance_stars()
# 
# summary_table <- clinical_multi_df[,.(age_at_diagnosis,patient_group,figo_staging,performance_status,
#                          brca_status,surgical_outcome,maintenance_therapy)] %>% 
#   tbl_summary(missing = "no") %>% 
#   add_n() %>% 
#   modify_header(stat_0 ~ "**n (%)**") %>%
#   modify_footnote(stat_0 ~ NA_character_)


combined_survival_table <-
  tbl_merge(
    tbls = list(os_surv_table, pfs_surv_table),
    tab_spanner = c("**Overall survival**", "**Progression free survival**")
  )

combined_survival_table
```
### Chemo change vs surgical outcome 
```{r}
chemo_change_vs_surgical_outcome_df <- clinical_multi_df %>% 
  filter(patient_group %in% c("6_cycle_chemo_change_surgery", "6_cycle_no_chemo_change_surgery")) %>% 
  filter(!is.na(surgical_outcome)) %>% 
  count(surgical_outcome, patient_group) %>% 
  pivot_wider(names_from = patient_group, values_from = n)

```



```{r}
chemo_change_vs_surgical_outcome_df %>% 
  select(-surgical_outcome) %>% 
  chisq.test()
```
### Type of chemo's impact on operability
```{r}


chemo_grouped_df <- clinical_df %>% 
  mutate(
    type_of_chemo_cleaned = 
      case_when(
        type_of_chemo %in% c("NA", "N/A", "??") ~ NA_character_,
        str_detect(type_of_chemo, "(?i)carbo.*pac.*") ~ "1",
        str_detect(type_of_chemo, "(?i)single.*carbo.*") ~ "2",
        TRUE ~ "3" 
      )
  
### three groups you can find: 
### carboplatin + pac
### carboplatin alone 
### other combinations e.g. Carboplatin + paclitaxel, bevacizumab 
  ) %>% 
  mutate(operability = 
         case_when(
           patient_group == "6_cycle_no_surgery" ~ FALSE, 
           is.na(patient_group) ~ NA, 
           patient_group == "6_cycle_no_chemo_change_surgery" ~ NA,
           TRUE ~ TRUE
         )
       )



chemo_grouped_df %>%
  select(operability, type_of_chemo_cleaned) %>% 
  drop_na() %>% 
  count(operability, type_of_chemo_cleaned) %>% 
  ggplot() +
  geom_col() +
  aes(x = type_of_chemo_cleaned, fill = operability, y = n) +
  xlab("Type of Chemotherapy")
  

```
### change in chemo vs no change in chemo

```{r}
chemo_grouped_df %>% count(change_in_chemo, operability) %>% 
  drop_na() %>% 
  pivot_wider(names_from = change_in_chemo, values_from = n) %>% 
  mutate(no_change = replace_na(no_change, 0)) %>% 
  chisq.test()
```

